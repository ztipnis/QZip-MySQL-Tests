#!/bin/bash
spinner()
{
    local pid=$!
    local delay=0.75
    local spinstr='|/-\'
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf " [%c]  " "$spinstr"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b\b\b\b\b\b"
    done
    printf "    \b\b\b\b"
}

sudo /home/abc/xubin/project/HoldMemory/.holdRAM 48
sysbench oltp_write_only --create_table_options="COMPRESSION=\"zlib\"" --mysql_storage_engine=innodb --table-size=50000000 --tables=8 --mysql-socket=/tmp/mysql.sock --mysql-user=root --mysql-password=xubin@cii9123 --mysql-db=sysdb_zlib --time=1800 --threads=16 --report-interval=10 prepare > prepare.log

PS3="Select test: "
compression_types=("write_only" "read_only" "read_write" "all" "back")
select c in "${compression_types[@]}"
do
  sudo sh -c "echo 3 > /proc/sys/vm/drop_caches"
  case $c in
    "back")
      break
      ;;
    "write_only"|"read_only"|"read_write")
      eval "iostat sda -p nvme0n1 nvme0n2 1 > $(echo $c)_io.log &"
      eval "vmstat 1 > $(echo $c)_vm.log &"
      echo "Running test: $c"
      eval "(sysbench oltp_$c --create_table_options=\"COMPRESSION=$(echo \"zlib\")\" --mysql_storage_engine=innodb --table-size=50000000 --tables=8 --mysql-socket=/tmp/mysql.sock --mysql-user=root --mysql-password=xubin@cii9123 --mysql-db=sysdb_zlib --time=1800 --threads=16 --report-interval=10 run > oltp_read_only.log)" & spinner
      sudo kill -9 $(pidof iostat)
      sudo kill -9 $(pidof vmstat)
      break
      ;;
    "all")
      ./zlib.all
     break;;
    *) echo "Invalid test...";;
  esac
done
